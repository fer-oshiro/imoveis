name: Deploy (SST)

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Select stage & role
        id: sel
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "STAGE=prod" >> $GITHUB_OUTPUT
            echo "ROLE=arn:aws:iam::121620439865:role/sst-deploy-prod" >> $GITHUB_OUTPUT
          else
            echo "STAGE=stg" >> $GITHUB_OUTPUT
            echo "ROLE=arn:aws:iam::121620439865:role/sst-deploy-stg" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS creds (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.sel.outputs.ROLE }}
          role-session-name: gha-${{ github.run_id }}
          aws-region: us-east-1

      - name: Deploy SST
        run: npx sst deploy --stage ${{ steps.sel.outputs.STAGE }}
